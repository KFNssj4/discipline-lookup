<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Discipline Action Lookup</title>
  <style>
    :root { --border:#e5e7eb; --text:#111827; --muted:#6b7280; --bg:#f9fafb; --danger:#b91c1c; --dangerBg:#fee2e2; }

    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px; }
    .card { background:white; border:1px solid var(--border); border-radius:14px; padding:20px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    p { margin: 0 0 18px; color: var(--muted); }
    .grid { display:grid; grid-template-columns: 1fr 220px; gap: 12px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom:6px; }

    /* Inputs */
    select, input {
      width: 100%;
      padding: 10px 12px;

      border: 1px solid var(--border) !important;
      border-radius: 10px !important;

      font-size: 14px;
      color: var(--text);
      background-color: #ffffff !important;

      -webkit-appearance: none;
      appearance: none;

      outline: none !important;
      box-shadow: none !important;
      background-image: none !important;

      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    select:focus,
    input:focus,
    input:focus-visible,
    input:active {
      background-color: #ffffff !important;
      border-color: #6366f1 !important;
      box-shadow: 0 0 0 2px rgba(99,102,241,.15) !important;
      outline: none !important;
    }

    input:-webkit-autofill,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:active {
      -webkit-box-shadow: 0 0 0px 1000px #ffffff inset !important;
      -webkit-text-fill-color: var(--text) !important;
    }

    /* Custom suggestion dropdown */
    .inputWrap { position: relative; }

    .suggestions {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
  max-height: 260px;
  overflow: auto;
  z-index: 50;

  -webkit-overflow-scrolling: touch; /* iOS smooth scroll */
  touch-action: pan-y;               /* allow vertical scrolling */
}

    .suggestion {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1.2;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: pan-y; /* allow vertical scrolling on mobile */
    }

    .suggestion:hover,
    .suggestion.active {
      background: #f3f4f6;
    }

    .notice {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185, 28, 28, .35);
      background: var(--dangerBg);
      color: var(--danger);
      font-weight: 650;
      display: none;
    }

    .result { margin-top: 12px; padding: 14px; border:1px solid var(--border); border-radius:12px; background:#fff; }
    .result h2 { font-size: 14px; margin:0 0 6px; color: var(--muted); }
    .result .action { font-size: 18px; font-weight: 650; line-height:1.35; white-space: pre-line; }
    .footer { margin-top: 12px; font-size: 12px; color: var(--muted); }
    @media (max-width: 700px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Discipline Action Lookup</h1>
      <p>Select an offense and the infraction count to see the recommended action.</p>

      <div class="grid">
        <div>
          <label for="offenseInput">Offense</label>

          <div class="inputWrap">
            <input
              id="offenseInput"
              placeholder="Type to search or click to browse…"
              autocomplete="off"
              autocapitalize="none"
              autocorrect="off"
              spellcheck="false"
            />
            <div id="suggestions" class="suggestions" hidden></div>
          </div>
        </div>

        <div>
          <label for="count">Infraction count</label>
          <select id="count">
            <option value="1">1st offense</option>
            <option value="2">2nd offense</option>
            <option value="3">3rd+ offense</option>
          </select>
        </div>
      </div>

      <div class="notice" id="unlawfulNotice">Unlawful act (may require law enforcement / district reporting per policy).</div>

      <div class="result" id="result" aria-live="polite">
        <h2>Action</h2>
        <div class="action" id="actionText">Loading…</div>
        <div class="footer" id="meta"></div>
      </div>
    </div>
  </div>

<script>
  let matrix = [];
  let selectedRow = null;         // set when user picks a suggestion
  let isLockedSelection = false;  // stays locked until user types again

  function normalizeCount(v) {
    const n = Number(v);
    if (Number.isNaN(n) || n <= 1) return 1;
    if (n === 2) return 2;
    return 3; // 3+
  }

  function getAction(row, count) {
    if (!row) return "Type or browse offenses to see the recommended action.";
    const c = normalizeCount(count);
    if (c === 1) return row.action1 || "(No action listed for 1st offense)";
    if (c === 2) return row.action2 || "(No action listed for 2nd offense)";
    return row.action3 || "(No action listed for 3rd+ offense)";
  }

  function norm(s) {
    return (s || "").toString().trim().toLowerCase();
  }

  // Forgiving search key: lowercased, punctuation removed, spaces normalized
  function makeSearchKey(s) {
    return norm(s)
      .replace(/['’]/g, "")
      .replace(/[^a-z0-9]+/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function tokenize(s) {
    const key = makeSearchKey(s);
    return key ? key.split(" ") : [];
  }

  // Query token variants to catch common cases like vape -> vaping (silent e)
  function variantsForToken(qt) {
    const v = [];
    if (!qt) return v;
    v.push(qt);

    // silent-e drop: "vape" -> "vap" (so it matches "vaping")
    if (qt.endsWith("e") && qt.length > 2) v.push(qt.slice(0, -1));

    // de-dupe
    return [...new Set(v)];
  }

  // Option A behavior:
  // - Empty query => show ALL offenses
  // - Non-empty => score and filter
  function getMatches(query) {
    const qKey = makeSearchKey(query);

    // Empty: return everything (already sorted in init)
    if (!qKey) return matrix.slice();

    const qTokens = qKey.split(" ").filter(Boolean);

    const scored = [];

    for (const r of matrix) {
      const key = r._searchKey;
      const tokens = r._tokens;

      let startScore = 0;
      let containScore = 0;

      for (const qt of qTokens) {
        const vars = variantsForToken(qt);

        // Strong: any word starts with token variant
        const wordStartMatch = vars.some(v => tokens.some(t => t.startsWith(v)));
        if (wordStartMatch) {
          startScore += 2;
          continue;
        }

        // Weaker: anywhere in key
        const containsMatch = vars.some(v => key.includes(v));
        if (containsMatch) containScore += 1;
      }

      const totalScore = startScore + containScore;
      if (totalScore > 0) scored.push({ row: r, score: totalScore });
    }

    // Higher score first; tie-break alphabetically
    scored.sort((a, b) => (b.score - a.score) || a.row.offense.localeCompare(b.row.offense));

    return scored.map(x => x.row);
  }

  function topMatch(query) {
    const matches = getMatches(query);
    // For empty query, "top match" should be first offense alphabetically
    return matches.length ? matches[0] : null;
  }

  function renderAction(row) {
    const countSel = document.getElementById("count");
    const actionText = document.getElementById("actionText");
    const meta = document.getElementById("meta");
    const notice = document.getElementById("unlawfulNotice");

    actionText.textContent = getAction(row, countSel.value);
    notice.style.display = (row && row.unlawful === true) ? "block" : "none";

    const label = countSel.value === "1" ? "1st" : (countSel.value === "2" ? "2nd" : "3rd+");
    meta.textContent = row ? `${row.offense} • ${label} offense` : "";
  }

  function showSuggestions(matches, activeIndex = 0) {
  const box = document.getElementById("suggestions");

  if (!matches.length) {
    box.hidden = true;
    box.innerHTML = "";
    return;
  }

  // Render ALL offenses (Option A). The box scrolls.
  box.hidden = false;
  box.innerHTML = matches.map((r, i) => `
    <div class="suggestion ${i === activeIndex ? "active" : ""}" data-offense="${escapeHtml(r.offense)}">
      ${escapeHtml(r.offense)}
    </div>
  `).join("");

  box.querySelectorAll(".suggestion").forEach(el => {

    // Desktop: click works normally
    el.addEventListener("mousedown", (e) => {
      e.preventDefault();
      selectOffense(el.getAttribute("data-offense"));
    });

    // Mobile: tap selects, scroll does NOT select
    let startY = 0;
    let startX = 0;
    let moved = false;

    el.addEventListener("touchstart", (e) => {
      moved = false;
      startY = e.touches[0].clientY;
      startX = e.touches[0].clientX;
    }, { passive: true });

    el.addEventListener("touchmove", (e) => {
      const dy = Math.abs(e.touches[0].clientY - startY);
      const dx = Math.abs(e.touches[0].clientX - startX);
      if (dy > 8 || dx > 8) moved = true;
    }, { passive: true });

    el.addEventListener("touchend", () => {
      if (moved) return;
      selectOffense(el.getAttribute("data-offense"));
    });

  }); // closes forEach

} // closes showSuggestions


  function hideSuggestions() {
    const box = document.getElementById("suggestions");
    box.hidden = true;
    box.innerHTML = "";
  }

  function selectOffense(offenseText) {
    const input = document.getElementById("offenseInput");
    input.value = offenseText;

    selectedRow = matrix.find(r => r.offense === offenseText) || null;
    isLockedSelection = true;

    hideSuggestions();
    renderAction(selectedRow);
  }

  function handleTyping() {
    const input = document.getElementById("offenseInput");
    const q = input.value;

    // Any typing unlocks selection (resume "top match while typing")
    isLockedSelection = false;
    selectedRow = null;

    const matches = getMatches(q);
    showSuggestions(matches);

    // Show action for top match immediately (no label)
    renderAction(matches.length ? matches[0] : null);
  }

  function openDropdown() {
    const input = document.getElementById("offenseInput");
    const matches = getMatches(input.value);
    showSuggestions(matches);

    // If not locked, show top match while browsing/typing
    if (!(isLockedSelection && selectedRow)) {
      renderAction(matches.length ? matches[0] : null);
    }
  }

  async function init() {
    const input = document.getElementById("offenseInput");
    const countSel = document.getElementById("count");
    const wrap = document.querySelector(".inputWrap");

    const res = await fetch("data.json", { cache: "no-store" });
    matrix = await res.json();

    // Precompute search fields
    matrix.forEach(r => {
      r._searchKey = makeSearchKey(r.offense);
      r._tokens = tokenize(r.offense);
    });

    // Sort alphabetically for "browse all"
    matrix.sort((a,b) => a.offense.localeCompare(b.offense));

    // Type to filter
    input.addEventListener("input", handleTyping);

    // Click/focus to browse all (Option A)
    input.addEventListener("focus", openDropdown);
    input.addEventListener("click", openDropdown);

    // Count change: respect locked selection, otherwise keep using top match
    countSel.addEventListener("change", () => {
      if (isLockedSelection && selectedRow) renderAction(selectedRow);
      else renderAction(topMatch(input.value));
    });

    // Hide suggestions if clicking outside
    document.addEventListener("click", (e) => {
      if (wrap && !wrap.contains(e.target)) hideSuggestions();
    });

    document.getElementById("actionText").textContent =
      "Type or click the offense box to browse all offenses.";
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[s]));
  }

  init().catch(err => {
    console.error(err);
    document.getElementById("actionText").textContent =
      "Could not load data.json. Make sure data.json is in the same folder as index.html.";
  });
</script>
</body>
</html>
   